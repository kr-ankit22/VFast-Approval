
# VFast Booker: Authentication and User Management Summary

This document provides a detailed summary of the authentication and user management features of the VFast Booker application.

## 1. Authentication and User Management Technologies

The following key dependencies from `package.json` are relevant to authentication, user management, and UI components:

**Authentication & User Management:**
*   `passport`: A popular authentication middleware for Node.js.
*   `passport-local`: A Passport strategy for authenticating with a username and password.
*   `passport-google-oauth20`: A Passport strategy for authenticating with Google OAuth 2.0.
*   `passport-jwt`: A Passport strategy for authenticating with JSON Web Tokens (JWTs).
*   `bcrypt`: A library for hashing passwords.
*   `jsonwebtoken`: A library for creating and verifying JWTs.
*   `express-session`: A middleware for managing sessions in Express.
*   `connect-pg-simple`: A session store for `express-session` that uses PostgreSQL.

**Form Handling:**
*   `react-hook-form`: A library for managing forms in React.
*   `zod`: A TypeScript-first schema declaration and validation library, often used with `react-hook-form`.
*   `@hookform/resolvers`: A library to connect `react-hook-form` with validation libraries like `zod`.

**UI Components & Frameworks:**
*   `react`: The core UI library.
*   `@radix-ui/*`: A collection of unstyled, accessible UI components.
*   `tailwindcss`: A utility-first CSS framework.
*   `lucide-react`: A library of icons.
*   `shadcn-ui`: The project uses `shadcn-ui` components, which are built on top of Radix UI and Tailwind CSS.

## 2. Authentication Implementation

### Main Login Component (`client/src/pages/auth-page.tsx`)

This component provides the UI for both login and registration.

```tsx
import { useState, useEffect } from "react";
import { Link, useLocation } from "wouter";
import { useAuth } from "@/hooks/use-auth";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";
import { UserRole } from "@shared/schema";
import Header from "@/components/layout/header";
import Footer from "@/components/layout/footer";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  Tabs,
  TabsContent,
  TabsList,
  TabsTrigger,
} from "@/components/ui/tabs";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

// Login schema
const loginSchema = z.object({
  email: z.string().email("Please enter a valid email address"),
  password: z.string().min(6, "Password must be at least 6 characters"),
});

// Registration schema
const registerSchema = z.object({
  name: z.string().min(2, "Name must be at least 2 characters"),
  email: z.string().email("Please enter a valid email address"),
  password: z.string().min(6, "Password must be at least 6 characters"),
  confirmPassword: z.string().min(6, "Password must be at least 6 characters"),
  role: z.enum([UserRole.BOOKING, UserRole.DEPARTMENT_APPROVER, UserRole.ADMIN, UserRole.VFAST]),
  phone: z.string().optional(),
  department: z.string().optional(),
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords do not match",
  path: ["confirmPassword"],
});

type LoginFormValues = z.infer<typeof loginSchema>;
type RegisterFormValues = z.infer<typeof registerSchema>;

export default function AuthPage() {
  const [activeTab, setActiveTab] = useState<string>("login");
  const { user, loginMutation, registerMutation } = useAuth();
  const [, navigate] = useLocation();

  // Redirect to appropriate dashboard if user is already logged in
  useEffect(() => {
    if (user) {
      switch (user.role) {
        case UserRole.BOOKING:
          navigate("/booking");
          break;
        case UserRole.DEPARTMENT_APPROVER:
          navigate("/department");
          break;
        case UserRole.ADMIN:
          navigate("/admin");
          break;
        case UserRole.VFAST:
          navigate("/vfast");
          break;
        default:
          navigate("/");
      }
    }
  }, [user, navigate]);

  // Login form
  const loginForm = useForm<LoginFormValues>({
    resolver: zodResolver(loginSchema),
    defaultValues: {
      email: "",
      password: "",
    },
  });

  // Register form
  const registerForm = useForm<RegisterFormValues>({
    resolver: zodResolver(registerSchema),
    defaultValues: {
      name: "",
      email: "",
      password: "",
      confirmPassword: "",
      role: UserRole.BOOKING,
      phone: "",
      department: "",
    },
  });

  const onLoginSubmit = (data: LoginFormValues) => {
    loginMutation.mutate(data);
  };

  const onRegisterSubmit = (data: RegisterFormValues) => {
    registerMutation.mutate(data);
  };

  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-grow bg-background py-12">
        <div className="container mx-auto px-4">
          <div className="flex flex-col md:flex-row gap-8 items-center">
            {/* Left Side - Form */}
            <div className="w-full md:w-1/2 max-w-md mx-auto md:mx-0">
              <Card className="w-full shadow-lg">
                <CardHeader>
                  <CardTitle className="text-2xl font-bold text-primary">
                    {activeTab === "login" ? "Sign In" : "Create an Account"}
                  </CardTitle>
                  <CardDescription>
                    {activeTab === "login"
                      ? "Enter your credentials to access your account"
                      : "Fill in the details to create a new account"}
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <Tabs value={activeTab} onValueChange={setActiveTab}>
                    <TabsList className="grid w-full grid-cols-2 mb-6">
                      <TabsTrigger value="login">Login</TabsTrigger>
                      <TabsTrigger value="register">Register</TabsTrigger>
                    </TabsList>

                    {/* Login Form */}
                    <TabsContent value="login">
                      <div className="space-y-4">
                        <Button variant="outline" className="w-full" asChild>
                          <a href="/api/auth/google">
                            <svg className="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.021,35.596,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                            Sign in with Google
                          </a>
                        </Button>
                        <div className="relative">
                          <div className="absolute inset-0 flex items-center">
                            <span className="w-full border-t" />
                          </div>
                          <div className="relative flex justify-center text-xs uppercase">
                            <span className="bg-background px-2 text-muted-foreground">
                              Or continue with
                            </span>
                          </div>
                        </div>
                      </div>
                      <Form {...loginForm}>
                        <form
                          onSubmit={loginForm.handleSubmit(onLoginSubmit)}
                          className="space-y-4"
                        >
                          <FormField
                            control={loginForm.control}
                            name="email"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Email</FormLabel>
                                <FormControl>
                                  <Input
                                    placeholder="your.email@example.com"
                                    {...field}
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <FormField
                            control={loginForm.control}
                            name="password"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Password</FormLabel>
                                <FormControl>
                                  <Input
                                    type="password"
                                    placeholder="••••••••"
                                    {...field}
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <Button
                            type="submit"
                            className="w-full"
                            disabled={loginMutation.isPending}
                          >
                            {loginMutation.isPending
                              ? "Signing In..."
                              : "Sign In"}
                          </Button>
                        </form>
                      </Form>
                    </TabsContent>

                    {/* Register Form */}
                    <TabsContent value="register">
                      <Form {...registerForm}>
                        <form
                          onSubmit={registerForm.handleSubmit(onRegisterSubmit)}
                          className="space-y-4"
                        >
                          <FormField
                            control={registerForm.control}
                            name="name"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Full Name</FormLabel>
                                <FormControl>
                                  <Input
                                    placeholder="John Doe"
                                    {...field}
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <FormField
                            control={registerForm.control}
                            name="email"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>Email</FormLabel>
                                <FormControl>
                                  <Input
                                    placeholder="your.email@example.com"
                                    {...field}
                                  />
                                </FormControl>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormField
                              control={registerForm.control}
                              name="password"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Password</FormLabel>
                                  <FormControl>
                                    <Input
                                      type="password"
                                      placeholder="••••••••"
                                      {...field}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />

                            <FormField
                              control={registerForm.control}
                              name="confirmPassword"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Confirm Password</FormLabel>
                                  <FormControl>
                                    <Input
                                      type="password"
                                      placeholder="••••••••"
                                      {...field}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>

                          <FormField
                            control={registerForm.control}
                            name="role"
                            render={({ field }) => (
                              <FormItem>
                                <FormLabel>User Type</FormLabel>
                                <Select
                                  onValueChange={field.onChange}
                                  defaultValue={field.value}
                                >
                                  <FormControl>
                                    <SelectTrigger>
                                      <SelectValue placeholder="Select user type" />
                                    </SelectTrigger>
                                  </FormControl>
                                  <SelectContent>
                                    <SelectItem value={UserRole.BOOKING}>
                                      Requestor
                                    </SelectItem>
                                    <SelectItem value={UserRole.DEPARTMENT_APPROVER}>
                                      Department Approver
                                    </SelectItem>
                                    <SelectItem value={UserRole.ADMIN}>
                                      Admin
                                    </SelectItem>
                                    <SelectItem value={UserRole.VFAST}>
                                      VFast
                                    </SelectItem>
                                  </SelectContent>
                                </Select>
                                <FormDescription>
                                  Select the appropriate user type based on your role
                                </FormDescription>
                                <FormMessage />
                              </FormItem>
                            )}
                          />

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <FormField
                              control={registerForm.control}
                              name="phone"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Phone (Optional)</FormLabel>
                                  <FormControl>
                                    <Input
                                      placeholder="+91 98765 43210"
                                      {...field}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />

                            <FormField
                              control={registerForm.control}
                              name="department"
                              render={({ field }) => (
                                <FormItem>
                                  <FormLabel>Department (Optional)</FormLabel>
                                  <FormControl>
                                    <Input
                                      placeholder="Computer Science, Physics, etc."
                                      {...field}
                                    />
                                  </FormControl>
                                  <FormMessage />
                                </FormItem>
                              )}
                            />
                          </div>

                          <Button
                            type="submit"
                            className="w-full"
                            disabled={registerMutation.isPending}
                          >
                            {registerMutation.isPending
                              ? "Creating Account..."
                              : "Create Account"}
                          </Button>
                        </form>
                      </Form>
                    </TabsContent>
                  </Tabs>
                </CardContent>
                <CardFooter className="flex flex-col space-y-2">
                  <div className="text-sm text-gray-600 text-center">
                    {activeTab === "login" ? (
                      <>
                        Don't have an account?{" "}
                        <button
                          onClick={() => setActiveTab("register")}
                          className="text-primary hover:underline"
                        >
                          Sign up
                        </button>
                      </>
                    ) : (
                      <>
                        Already have an account?{" "}
                        <button
                          onClick={() => setActiveTab("login")}
                          className="text-primary hover:underline"
                        >
                          Sign in
                        </button>
                      </>
                    )}
                  </div>
                  <div className="text-xs text-gray-500 text-center pt-2">
                    By continuing, you agree to our Terms of Service and Privacy Policy.
                  </div>
                </CardFooter>
              </Card>
            </div>

            {/* Right Side - Info */}
            <div className="w-full md:w-1/2 mt-8 md:mt-0 text-center md:text-left">
              <h1 className="text-3xl md:text-4xl font-bold text-primary mb-4">
                VFast Hostel Booking System
              </h1>
              <p className="text-xl text-gray-600 mb-6">
                Your gateway to seamless accommodation at BITS Pilani
              </p>
              <div className="space-y-6">
                <div className="flex flex-col md:flex-row items-center md:items-start gap-4">
                  <div className="bg-primary text-white p-3 rounded-full">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    >
                      <path d="M20 5H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z" />
                      <path d="M16 2v6" />
                      <path d="M12 2v6" />
                      <path d="M8 2v6" />
                      <path d="M4 19h16" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold">Easy Booking</h3>
                    <p className="text-gray-600">
                      Book your stay in just a few clicks with our intuitive interface
                    </p>
                  </div>
                </div>

                <div className="flex flex-col md:flex-row items-center md:items-start gap-4">
                  <div className="bg-primary text-white p-3 rounded-full">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    >
                      <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                      <circle cx="12" cy="12" r="3" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold">Real-Time Tracking</h3>
                    <p className="text-gray-600">
                      Monitor the status of your booking requests at any time
                    </p>
                  </div>
                </div>

                <div className="flex flex-col md:flex-row items-center md:items-start gap-4">
                  <div className="bg-primary text-white p-3 rounded-full">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      strokeWidth="2"
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    >
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                      <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold">Seamless Experience</h3>
                    <p className="text-gray-600">
                      From booking to check-out, enjoy a hassle-free stay at VFast Hostel
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <Footer />
    </div>
  );
}
```

### Authentication Hook (`client/src/hooks/use-auth.tsx`)

This hook provides the logic for handling authentication-related mutations.

```tsx
import { createContext, ReactNode, useContext } from "react";
import { useQuery, useMutation, UseMutationResult } from "@tanstack/react-query";
import { insertUserSchema, LoginUser, UserRole } from "@shared/schema";
import { getQueryFn, apiRequest, queryClient } from "../lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { useLocation } from "wouter";

type User = {
  id: number;
  name: string;
  email: string;
  role: UserRole;
  phone?: string;
  department?: string;
  createdAt: Date;
};

type AuthContextType = {
  user: User | null;
  isLoading: boolean;
  error: Error | null;
  loginMutation: UseMutationResult<{ user: User, token: string }, Error, LoginUser>;
  logoutMutation: UseMutationResult<void, Error, void>;
  registerMutation: UseMutationResult<User, Error, any>;
  refetch: () => void;
};

export const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: ReactNode }) {
  const { toast } = useToast();
  const [, setLocation] = useLocation();

  const {
    data: user,
    error,
    isLoading,
    refetch,
  } = useQuery<User | undefined, Error>({
    queryKey: ["/api/users/me"],
    queryFn: getQueryFn({ on401: "returnNull" }),
  });

  const loginMutation = useMutation({
    mutationFn: async (credentials: LoginUser) => {
      const res = await apiRequest("POST", "/api/login", credentials);
      return await res.json();
    },
    onSuccess: (data: { user: User, token: string }) => {
      localStorage.setItem("token", data.token);
      
      // Set the user data in cache
      queryClient.setQueryData(["/api/users/me"], data.user);
      
      // Show success toast
      toast({
        title: "Login successful",
        description: `Welcome back, ${data.user.name}!`,
        variant: "default",
      });
      
      // Redirect to appropriate dashboard based on user role
      const redirectPath = data.user.role === UserRole.BOOKING 
        ? "/booking" 
        : data.user.role === UserRole.DEPARTMENT_APPROVER
          ? "/department"
          : data.user.role === UserRole.ADMIN
          ? "/admin"
          : data.user.role === UserRole.VFAST
            ? "/vfast"
            : "/";
            
      setLocation(redirectPath);
    },
    onError: (error: Error) => {
      toast({
        title: "Login failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const registerMutation = useMutation({
    mutationFn: async (userData: any) => {
      const res = await apiRequest("POST", "/api/register", userData);
      return await res.json();
    },
    onSuccess: (user: User) => {
      // Clear any stale query data first
      queryClient.clear();
      
      // Set the user data in cache
      queryClient.setQueryData(["/api/user"], user);
      
      // Show success toast
      toast({
        title: "Registration successful",
        description: `Welcome, ${user.name}!`,
        variant: "default",
      });
      
      // Redirect to appropriate dashboard based on user role
      const redirectPath = user.role === UserRole.BOOKING 
        ? "/booking" 
        : user.role === UserRole.DEPARTMENT_APPROVER
          ? "/department"
          : user.role === UserRole.ADMIN
          ? "/admin"
          : user.role === UserRole.VFAST
            ? "/vfast"
            : "/";
            
      setLocation(redirectPath);
    },
    onError: (error: Error) => {
      toast({
        title: "Registration failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const logoutMutation = useMutation({
    mutationFn: async () => {
      await apiRequest("POST", "/api/logout");
    },
    onSuccess: () => {
      localStorage.removeItem("token"); // Explicitly remove the JWT token
      // Clear all query cache to ensure clean state
      queryClient.clear();
      
      // Redirect to auth page
      setLocation("/auth");
      
      toast({
        title: "Logged out",
        description: "You have been successfully logged out.",
        variant: "default",
      });
    },
    onError: (error: Error) => {
      toast({
        title: "Logout failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  return (
    <AuthContext.Provider
      value={{
        user: user ?? null,
        isLoading,
        error,
        loginMutation,
        logoutMutation,
        registerMutation,
        refetch,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuth must be used within an AuthProvider");
  }
  return context;
}
```

### Server-Side Authentication (`server/auth.ts`)

This file configures Passport.js with `LocalStrategy` and `JwtStrategy`.

```typescript
import passport from 'passport';
import { Strategy as LocalStrategy } from 'passport-local';
import bcrypt from 'bcrypt';
import { db } from './db';
import { users } from '@shared/schema';
import { eq } from 'drizzle-orm';
import logger from './logger';
import { Strategy as JwtStrategy, ExtractJwt } from 'passport-jwt';

// logger.info("server/auth.ts: Initializing Passport strategies.");

// Local Strategy
passport.use(
  new LocalStrategy({ usernameField: 'email' }, async (email, password, done) => {
    try {
      const user = await db.query.users.findFirst({
        where: eq(users.email, email),
      });

      if (!user) {
        return done(null, false, { message: 'Incorrect email.' });
      }

      if (!user.password) {
        return done(null, false, { message: 'User registered via OAuth, please use Google login.' });
      }

      const isMatch = await bcrypt.compare(password, user.password);

      if (!isMatch) {
        return done(null, false, { message: 'Incorrect password.' });
      }

      return done(null, user);
    } catch (error) {
      return done(error);
    }
  })
);

// JWT Strategy
const jwtOptions = {
  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
  secretOrKey: process.env.JWT_SECRET,
};

// logger.info({ secretOrKey: jwtOptions.secretOrKey ? "[SECRET_PRESENT]" : "[SECRET_MISSING]" }, "JWT Strategy: Using secretOrKey");

passport.use(
  new JwtStrategy(jwtOptions, async (payload, done) => {
    // logger.info({ payload }, "JWT Strategy: Payload received");
    try {
      const user = await db.query.users.findFirst({
        where: eq(users.id, payload.id),
      });

      if (user) {
        // logger.info({ userId: user.id }, "JWT Strategy: User found");
        return done(null, user);
      } else {
        // logger.warn("JWT Strategy: User not found for payload:", payload);
        return done(null, false);
      }
    } catch (error) {
      // logger.error({ err: error }, "JWT Strategy: Error during user lookup");
      return done(error, false);
    }
  })
);

// Serialize user into the session
passport.serializeUser((user: any, done) => {

  done(null, user.id);
});

// Deserialize user from the session
passport.deserializeUser(async (id: string, done) => {

  try {
    const user = await db.query.users.findFirst({
      where: eq(users.id, parseInt(id, 10)),
    });

    done(null, user);
  } catch (error) {
    // logger.error({ err: error }, "Passport: Error deserializing user");
    done(error, undefined);
  }
});

export const authenticateJwt = passport.authenticate('jwt', { session: false });

export default passport;
```

### Google Authentication (`server/google-auth.ts`)

This file configures the Google OAuth 2.0 strategy for Passport.js.

```typescript
import passport from 'passport';
import { Strategy as GoogleStrategy } from 'passport-google-oauth20';
import { db } from './db';
import { users } from '@shared/schema';
import { eq } from 'drizzle-orm';
import logger from './logger';

passport.use(
  new GoogleStrategy(
    {
      clientID: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      callbackURL: process.env.GOOGLE_CALLBACK_URL!,
    },
    async (accessToken, refreshToken, profile, done) => {
      // logger.info("Google Auth Strategy: GOOGLE_CLIENT_ID used:", process.env.GOOGLE_CLIENT_ID);
      // logger.info("Google Auth Strategy: GOOGLE_CLIENT_SECRET used:", process.env.GOOGLE_CLIENT_SECRET);
      // logger.info("Google Auth Strategy: GOOGLE_CALLBACK_URL used:", process.env.GOOGLE_CALLBACK_URL);
      const email = profile.emails?.[0]?.value;
      // logger.info("Google Auth: Extracted email from profile:", email);

      if (!email) {
        // logger.warn("Google Auth: Email not found in Google profile.");
        return done(new Error('Email not found in Google profile'), undefined);
      }

      if (!email.endsWith('@pilani.bits-pilani.ac.in')) {
        // logger.warn("Google Auth: Email domain mismatch for:", email);
        return done(new Error('Only BITS Pilani emails are allowed'), undefined);
      }

      try {
        let user = await db.query.users.findFirst({
          where: eq(users.email, email),
        });
        // logger.info({ user }, "Google Auth: User found by email:");

        if (user) {
          if (!user.googleId) {
            // logger.info("Google Auth: Updating googleId for user:", user.id);
            await db.update(users).set({ googleId: profile.id }).where(eq(users.id, user.id));
          }
          // logger.info("Google Auth: Successfully authenticated user:", user.id);
          return done(null, user);
        } else {
          // logger.warn("Google Auth: User not found in DB for email:", email);
          return done(new Error('User not found. Please contact an administrator.'), undefined);
        }
      } catch (error) {
        // logger.error("Google Auth: Error during authentication:", error);
        return done(error, undefined);
      }
    }
  )
);

export default passport;
```

## 3. Database Schema for Users

The `users` table schema is defined in `shared/schema.ts`:

```typescript
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  password: text("password"),
  role: text("role").notNull().default(UserRole.BOOKING),
  googleId: text("google_id").unique(),
  mobileNumber: text("mobile_number"),
  department_id: integer("department_id").references(() => departments.id).notNull(),
  createdAt: timestamp("created_at").defaultNow(),
}, (users) => {
  return {
    emailIdx: uniqueIndex("email_idx").on(users.email),
  };
});
```

## 4. Local User Addition Feature

The "Add User" feature is part of the `user-management.tsx` component located in `client/src/pages/admin`.

### UI and Logic (`client/src/pages/admin/user-management.tsx`)

The following snippet shows the dialog for adding a new user and the mutation that handles the user creation.

```tsx
// Zod schema for creating/updating a user
const userFormSchema = z.object({
  name: z.string().min(2, "Name must be at least 2 characters"),
  email: z.string().email("Invalid email format"),
  password: z.string().optional(),
  confirmPassword: z.string().optional(),
  role: z.nativeEnum(UserRole),
  phone: z.string().optional().refine(val => !val || /^\d{10}$/.test(val), {
    message: "Phone number must be 10 digits",
  }),
  department: z.string({ required_error: "Department is required." }).min(1, "Department is required."),
  authMethod: z.enum(["Password", "Google"]),
}).superRefine(({ confirmPassword, password, authMethod }, ctx) => {
  if (authMethod === "Password") {
    if (!password || password.length < 6) {
      ctx.addIssue({
        code: "custom",
        path: ["password"],
        message: "Password must be at least 6 characters",
      });
    }
    if (password !== confirmPassword) {
      ctx.addIssue({
        code: "custom",
        path: ["confirmPassword"],
        message: "Passwords do not match",
      });
    }
  }
});

// ...

// Add/Edit User Mutation
const userMutation = useMutation({
  mutationFn: async (userData: UserFormValues & { id?: number }) => {
    if (userData.id) {
      // Update existing user
      const res = await apiRequest("PATCH", `/api/admin/users/${userData.id}`, userData);
      return res.data;
    } else {
      // Create new user
      const res = await apiRequest("POST", "/api/admin/users", userData);
      return res.data;
    }
  },
  onSuccess: () => {
    toast({
      title: editingUser ? "User Updated" : "User Created",
      description: editingUser ? "User details have been updated." : "New user has been created.",
    });
    setIsAddUserDialogOpen(false);
    setEditingUser(null);
    userForm.reset();
    queryClient.invalidateQueries({ queryKey: ["adminUsers"] });
    queryClient.invalidateQueries({ queryKey: ["userMetrics"] });
  },
  onError: (error: any) => {
    toast({
      title: editingUser ? "Update Failed" : "Creation Failed",
      description: error.response?.data?.message || "An unexpected error occurred.",
      variant: "destructive",
    });
  },
});

// ...

<Dialog open={isAddUserDialogOpen} onOpenChange={setIsAddUserDialogOpen}>
  <DialogTrigger asChild>
    <Button onClick={() => setEditingUser(null)}>
      <PlusCircle className="mr-2 h-4 w-4" /> Add New User
    </Button>
  </DialogTrigger>
  <DialogContent className="sm:max-w-md h-[90vh]">
    <DialogHeader>
      <DialogTitle>{editingUser ? "Edit User" : "Add New User"}</DialogTitle>
      <DialogDescription>
        {editingUser ? "Make changes to the user profile here." : "Fill in the details to create a new user account."}
        <p className="mt-2 text-sm text-muted-foreground">
          Users created with a BITS Pilani email can log in via Google. Their Google account will be automatically linked on first Google login.
        </p>
      </DialogDescription>
    </DialogHeader>
    <ScrollArea className="h-full">
      <TooltipProvider>
        <Form {...userForm}>
        <form onSubmit={userForm.handleSubmit(onUserFormSubmit)} className="space-y-4 pr-6">
          {/* Form Fields for name, email, password, role, department, etc. */}
        </form>
      </Form>
      </TooltipProvider>
    </ScrollArea>
  </DialogContent>
</Dialog>
```

## 5. Bulk CSV Upload for Users

The "Bulk CSV Upload" feature is also part of the `user-management.tsx` component.

### UI and Logic (`client/src/pages/admin/user-management.tsx`)

The following snippet shows the UI for uploading the CSV file and the mutation that handles the upload.

```tsx
// CSV Upload Mutation
const uploadMutation = useMutation({
  mutationFn: async (csvFile: File) => {
    const formData = new FormData();
    formData.append("file", csvFile);
    const res = await apiRequest("POST", "/api/admin/users/upload", formData);
    return res.data;
  },
  onSuccess: (data) => {
    toast({
      title: "Upload Successful",
      description: `Created ${data.created} users, updated ${data.updated} users.`, 
    });
    setFile(null);
    queryClient.invalidateQueries({ queryKey: ["adminUsers"] });
    queryClient.invalidateQueries({ queryKey: ["userMetrics"] });
  },
  onError: (error: any) => {
    toast({
      title: "Upload Failed",
      description: error.response?.data?.message || "An unexpected error occurred.",
      variant: "destructive",
    });
  },
});

// ...

const { getRootProps, getInputProps, isDragActive } = useDropzone({
  accept: { "text/csv": [".csv"] },
  onDrop: (acceptedFiles) => {
    if (acceptedFiles.length > 0) {
      setFile(acceptedFiles[0]);
    }
  },
});

// ...

<Card>
  <CardHeader>
    <CardTitle>Bulk User Upload (CSV)</CardTitle>
    <CardDescription>Upload a CSV file to create or update multiple user accounts.</CardDescription>
  </CardHeader>
  <CardContent className="space-y-6">
    <div className="space-y-2">
      <div className="flex items-center space-x-1">
        <Label htmlFor="csv-format-bulk">CSV Format</Label>
        <Tooltip>
          <TooltipTrigger asChild>
            <HelpCircle className="h-4 w-4 text-muted-foreground" />
          </TooltipTrigger>
          <TooltipContent>
            <p>Expected columns: `email`, `role`, `department`, `name` (optional), `phone` (optional).</p>
            <p>Roles: BOOKING, DEPARTMENT_APPROVER, ADMIN, VFAST.</p>
            <p>Department: Mandatory, must be the numerical ID of the department.</p>
            <p>Example: `john.doe@pilani.bits-pilani.ac.in,BOOKING,1,John Doe,+919876543210`</p>
          </TooltipContent>
        </Tooltip>
      </div>
      <Input
        id="csv-format-bulk"
        value="email,role,department,name,phone"
        readOnly
        className="font-mono bg-muted"
      />
      <p className="text-sm text-muted-foreground">
        The 'department' column is now mandatory for all users and must contain the department ID.
      </p>
    </div>

    <div
      {...getRootProps()}
      className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gray-400 transition-colors"
    >
      <input {...getInputProps()} />
      {uploadMutation.isPending ? (
        <div className="flex items-center justify-center space-x-2">
          <Loader2 className="h-5 w-5 animate-spin" />
          <span>Uploading...</span>
        </div>
      ) : isDragActive ? (
        <p>Drop the CSV file here ...</p>
      ) : file ? (
        <p>File selected: {file.name}</p>
      ) : (
        <p className="text-muted-foreground flex flex-col items-center">
          <UploadCloud className="h-8 w-8 mb-2" />
          Drag 'n' drop a CSV file here, or click to select one
        </p>
      )}
    </div>

    {file && !uploadMutation.isPending && (
      <Tooltip>
        <TooltipTrigger asChild>
          <Button onClick={handleCsvUpload} className="w-full">
            Upload CSV
          </Button>
        </TooltipTrigger>
        <TooltipContent>
          <p>Uploads the selected CSV file.</p>
          <p>Existing users (by email) will be updated, new users will be created.</p>
          <p>Any validation errors in the CSV will be reported.</p>
        </TooltipContent>
      </Tooltip>
    )}
  </CardContent>
</Card>
```

The backend logic for handling the CSV upload is located at the `/api/admin/users/upload` endpoint. This endpoint is responsible for parsing the CSV file and creating or updating users in the database.
